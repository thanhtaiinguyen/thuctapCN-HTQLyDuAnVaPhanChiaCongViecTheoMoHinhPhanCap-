@model IEnumerable<thuctapCN.Models.TaskListViewModel>

@{
    ViewData["Title"] = "C√¥ng vi·ªác c·ªßa t√¥i";
}

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="bi bi-person-workspace"></i> C√¥ng vi·ªác c·ªßa t√¥i</h2>
            <p class="text-muted mb-0">T·∫•t c·∫£ c√¥ng vi·ªác ƒë∆∞·ª£c giao</p>
        </div>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle"></i> @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (!Model.Any())
    {
        <div class="text-center py-5">
            <i class="bi bi-inbox" style="font-size: 4rem; color: #ccc;"></i>
            <p class="text-muted mt-3">B·∫°n ch∆∞a ƒë∆∞·ª£c giao c√¥ng vi·ªác n√†o.</p>
        </div>
    }
    else
    {
        @* Summary Cards *@
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-white bg-primary">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="bi bi-list-task"></i> T·ªïng s·ªë
                        </h5>
                        <h2 class="mb-0">@Model.Count()</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-info">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="bi bi-play-circle"></i> ƒêang th·ª±c hi·ªán
                        </h5>
                        <h2 class="mb-0">@Model.Count(t => t.Status == "ƒêang th·ª±c hi·ªán")</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-success">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="bi bi-check-circle"></i> Ho√†n th√†nh
                        </h5>
                        <h2 class="mb-0">@Model.Count(t => t.Status == "Ho√†n th√†nh")</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-danger">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="bi bi-exclamation-triangle"></i> Qu√° h·∫°n
                        </h5>
                        <h2 class="mb-0">@Model.Count(t => t.IsOverdue)</h2>
                    </div>
                </div>
            </div>
        </div>

        @* Group tasks by project *@
        @foreach (var projectGroup in Model.GroupBy(t => new { t.ProjectId, t.ProjectName, t.ProjectCode }))
        {
            <div class="card mb-3">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-folder"></i> @projectGroup.Key.ProjectCode - @projectGroup.Key.ProjectName
                        <span class="badge bg-secondary ms-2">@projectGroup.Count() c√¥ng vi·ªác</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>T√™n c√¥ng vi·ªác</th>
                                    <th>M·ª©c ƒë·ªô ∆∞u ti√™n</th>
                                    <th>Deadline</th>
                                    <th>Tr·∫°ng th√°i</th>
                                    <th>Ti·∫øn ƒë·ªô</th>
                                    <th class="text-center">Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var task in projectGroup.OrderBy(t => t.Status == "Ho√†n th√†nh" ? 1 : 0).ThenBy(t => t.Deadline))
                                {
                                    <tr class="@(task.IsOverdue && task.Status != "Ho√†n th√†nh" ? "table-danger" : "")">
                                        <td>
                                            <strong>@task.TaskName</strong>
                                            @if (task.IsOverdue)
                                            {
                                                <span class="badge bg-danger ms-2">Qu√° h·∫°n</span>
                                            }
                                        </td>
                                        <td>
                                            @if (task.Priority == "Cao")
                                            {
                                                <span class="badge bg-danger">üî¥ Cao</span>
                                            }
                                            else if (task.Priority == "Trung b√¨nh")
                                            {
                                                <span class="badge bg-warning text-dark">üü° Trung b√¨nh</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-success">üü¢ Th·∫•p</span>
                                            }
                                        </td>
                                        <td>
                                            @task.Deadline.ToString("dd/MM/yyyy")
                                            <br />
                                            <small class="text-muted">
                                                @{
                                                    var daysLeft = (task.Deadline.Date - DateTime.Now.Date).Days;
                                                    if (daysLeft < 0)
                                                    {
                                                        <span class="text-danger">Qu√° @Math.Abs(daysLeft) ng√†y</span>
                                                    }
                                                    else if (daysLeft == 0)
                                                    {
                                                        <span class="text-warning">H√¥m nay</span>
                                                    }
                                                    else if (daysLeft <= 2)
                                                    {
                                                        <span class="text-warning">C√≤n @daysLeft ng√†y</span>
                                                    }
                                                    else
                                                    {
                                                        <span>C√≤n @daysLeft ng√†y</span>
                                                    }
                                                }
                                            </small>
                                        </td>
                                        <td>
                                            @if (task.Status == "Ho√†n th√†nh")
                                            {
                                                <span class="badge bg-success">Ho√†n th√†nh</span>
                                            }
                                            else if (task.Status == "ƒêang th·ª±c hi·ªán")
                                            {
                                                <span class="badge bg-primary">ƒêang th·ª±c hi·ªán</span>
                                            }
                                            else if (task.Status == "T·∫°m d·ª´ng")
                                            {
                                                <span class="badge bg-secondary">T·∫°m d·ª´ng</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-light text-dark">Ch∆∞a b·∫Øt ƒë·∫ßu</span>
                                            }
                                        </td>
                                        <td>
                                            <div class="progress" style="height: 25px;">
                                                <div class="progress-bar @(task.Progress == 100 ? "bg-success" : "bg-info")" 
                                                     role="progressbar" 
                                                     style="width: @task.Progress%"
                                                     aria-valuenow="@task.Progress" 
                                                     aria-valuemin="0" 
                                                     aria-valuemax="100">
                                                    @task.Progress%
                                                </div>
                                            </div>
                                        </td>
                                        <td class="text-center">
                                            <div class="btn-group" role="group">
                                                <a asp-action="Details" asp-route-id="@task.Id" 
                                                   class="btn btn-sm btn-outline-info" title="Xem chi ti·∫øt">
                                                    <i class="bi bi-eye"></i>
                                                </a>
                                                <a asp-action="UpdateStatus" asp-route-id="@task.Id" 
                                                   class="btn btn-sm btn-outline-success" title="C·∫≠p nh·∫≠t tr·∫°ng th√°i">
                                                    <i class="bi bi-arrow-repeat"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        }
    }
</div>
