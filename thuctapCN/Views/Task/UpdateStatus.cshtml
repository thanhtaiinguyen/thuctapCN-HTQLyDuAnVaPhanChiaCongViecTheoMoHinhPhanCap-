@model thuctapCN.Models.UpdateTaskStatusViewModel

@{
    ViewData["Title"] = "Báo cáo công việc";
}

<div class="container mt-5" style="max-width: 800px;">
    <div class="mb-4">
        <h2 class="fw-bold text-dark mb-1">@Model.TaskName</h2>
        <p class="text-muted">
            Thuộc dự án: <span class="fw-medium text-primary">@Model.ProjectName</span>
        </p>
    </div>

    <form asp-action="UpdateStatus" method="post" enctype="multipart/form-data" class="needs-validation">
        <input type="hidden" asp-for="Id" />
        <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

        <div class="row g-4 mb-4">
            <div class="col-md-6">
                <label asp-for="Status" class="form-label fw-medium text-secondary small text-uppercase">Trạng thái hiện tại</label>
                <select asp-for="Status" class="form-select border-0 bg-light py-2">
                    <option value="Chưa bắt đầu">○ Chưa bắt đầu</option>
                    <option value="Đang thực hiện">⟳ Đang thực hiện</option>
                    <option value="Hoàn thành">✓ Hoàn thành</option>
                    <option value="Tạm dừng">⏸ Tạm dừng</option>
                </select>
                <span asp-validation-for="Status" class="text-danger small"></span>
            </div>

            <div class="col-md-6">
                <label asp-for="Progress" class="form-label fw-medium text-secondary small text-uppercase d-flex justify-content-between">
                    <span>Tiến độ hoàn thành</span>
                    <span id="progressValue" class="text-primary fw-bold">@Model.Progress%</span>
                </label>
                <input asp-for="Progress" type="range" class="form-range" min="0" max="100" step="5" 
                       oninput="document.getElementById('progressValue').textContent = this.value + '%'" />
                <span asp-validation-for="Progress" class="text-danger small"></span>
            </div>
        </div>

        <div class="mb-4">
            <label asp-for="Notes" class="form-label fw-medium text-secondary small text-uppercase">Nội dung báo cáo</label>
            <textarea asp-for="Notes" class="form-control border-light shadow-sm p-3" rows="8" 
                      placeholder="Mô tả chi tiết công việc bạn đã làm, những khó khăn gặp phải hoặc kết quả đạt được..."
                      style="resize: vertical; background-color: #fcfcfc;"></textarea>
            <span asp-validation-for="Notes" class="text-danger small"></span>
            <div class="text-end mt-1">
                <small class="text-muted" id="charCount">0/2000 ký tự</small>
            </div>
        </div>

        <div class="mb-5">
            <label asp-for="AttachmentFile" class="form-label fw-medium text-secondary small text-uppercase">
                <i class="bi bi-paperclip"></i> Đính kèm tài liệu (nếu có)
            </label>
            <input asp-for="AttachmentFile" type="file" class="form-control form-control-sm" 
                   accept=".pdf,.doc,.docx,.xls,.xlsx,.zip,.rar,.jpg,.jpeg,.png" />
            <span asp-validation-for="AttachmentFile" class="text-danger small"></span>
            
            @if (!string.IsNullOrEmpty(Model.CurrentAttachmentPath))
            {
                <div class="mt-2 p-2 bg-light rounded d-inline-block">
                    <small class="text-muted me-2">File hiện tại:</small>
                    <a href="@Model.CurrentAttachmentPath" target="_blank" class="text-decoration-none">
                        <i class="bi bi-file-earmark-text"></i> Xem file cũ
                    </a>
                </div>
            }
        </div>

        <div class="d-flex align-items-center gap-3">
            <button type="submit" class="btn btn-primary px-4 py-2 fw-medium">
                Gửi báo cáo
            </button>
            <a asp-action="Details" asp-route-id="@Model.Id" class="text-decoration-none text-secondary px-3">
                Hủy bỏ
            </a>
        </div>
    </form>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const progressSlider = document.querySelector('input[type="range"]');
            const progressValue = document.getElementById('progressValue');
            const statusSelect = document.querySelector('select[name="Status"]');
            const notesTextarea = document.querySelector('textarea[name="Notes"]');
            const charCount = document.getElementById('charCount');

            // Update progress value
            if (progressSlider && progressValue) {
                progressSlider.addEventListener('input', function() {
                    progressValue.textContent = this.value + '%';
                    
                    // Auto update status to "Hoàn thành" if 100%
                    if (this.value == 100 && statusSelect) {
                        statusSelect.value = 'Hoàn thành';
                    } else if (this.value < 100 && statusSelect && statusSelect.value === 'Hoàn thành') {
                        statusSelect.value = 'Đang thực hiện';
                    }
                });
            }

            // Update status logic
            if (statusSelect && progressSlider) {
                statusSelect.addEventListener('change', function() {
                    if (this.value === 'Hoàn thành') {
                        progressSlider.value = 100;
                        progressValue.textContent = '100%';
                    } else if (this.value === 'Chưa bắt đầu') {
                        progressSlider.value = 0;
                        progressValue.textContent = '0%';
                    }
                });
            }

            // Character counter
            if (notesTextarea && charCount) {
                notesTextarea.addEventListener('input', function() {
                    const currentLength = this.value.length;
                    charCount.textContent = currentLength + '/2000 ký tự';
                    if (currentLength > 2000) {
                        charCount.classList.add('text-danger');
                    } else {
                        charCount.classList.remove('text-danger');
                    }
                });
                // Init
                charCount.textContent = notesTextarea.value.length + '/2000 ký tự';
            }
        });
    </script>
}
